name: Native Build

on:
  workflow_call:
    inputs:
      runner:
        description: GitHub runner label to execute the build.
        type: string
        required: true
      configuration:
        description: Build configuration (e.g. Release, Debug).
        type: string
        default: Release
      architecture:
        description: Optional target architecture (e.g. arm64) for Windows builds.
        type: string
        default: ""
      artifact-name:
        description: Name to use when uploading the native artifact.
        type: string
        required: true
      skip-dotnet:
        description: Skip the dotnet restore/build/pack steps inside build scripts.
        type: boolean
        default: true
      skip-tests:
        description: Skip native test execution inside build scripts.
        type: boolean
        default: true
      dotnet-version:
        description: .NET version to install.
        type: string
        default: 8.0.x
    outputs:
      rid:
        description: Runtime identifier generated by the native build.
        value: ${{ jobs.build.outputs.rid }}

jobs:
  build:
    runs-on: ${{ inputs.runner }}
    outputs:
      rid: ${{ steps.runtime-info.outputs.rid }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Install dependencies (Linux)
        if: startsWith(inputs.runner, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev ninja-build clang-format zip
        shell: bash

      - name: Install dependencies (macOS)
        if: startsWith(inputs.runner, 'macos')
        run: |
          brew update
          brew install gtk+3 ninja clang-format
        shell: bash

      - name: Install dependencies (Windows)
        if: startsWith(inputs.runner, 'windows')
        run: choco install ninja -y
        shell: pwsh

      - name: Package native artifacts (Unix)
        if: startsWith(inputs.runner, 'ubuntu') || startsWith(inputs.runner, 'macos')
        shell: bash
        run: |
          set -euo pipefail
          args=("${{ inputs.configuration }}")
          if [[ '${{ inputs.skip-dotnet }}' == 'true' ]]; then
            args+=('--skip-dotnet')
          fi
          if [[ '${{ inputs.skip-tests }}' == 'true' ]]; then
            args+=('--skip-tests')
          fi
          ./build/build.sh "${args[@]}"

      - name: Package native artifacts (Windows)
        if: startsWith(inputs.runner, 'windows')
        shell: pwsh
        run: |
          $params = @{
            Configuration = '${{ inputs.configuration }}'
          }
          if ('${{ inputs.skip-dotnet }}' -eq 'true') { $params.SkipDotnet = $true }
          if ('${{ inputs.skip-tests }}' -eq 'true') { $params.SkipTests = $true }
          if ('${{ inputs.architecture }}') { $params.Architecture = '${{ inputs.architecture }}' }
          ./build/build.ps1 @params

      - name: Determine runtime identifier
        id: runtime-info
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(artifacts/native-*.zip)
          if (( ${#files[@]} == 0 )); then
            echo "No native archives found under artifacts/" >&2
            exit 1
          fi
          archive="${files[0]}"
          rid="${archive#artifacts/native-}"
          rid="${rid%.zip}"
          echo "rid=${rid}" >> "${GITHUB_OUTPUT}"

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: artifacts/native-*.zip
          if-no-files-found: error
